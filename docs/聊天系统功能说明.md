# 聊天系统功能说明

## 📋 功能概述

聊天系统是幻境FiveM服务器网站的核心社交功能之一，允许用户与好友进行实时文字聊天，增强用户之间的互动体验。

## 🎯 功能特性

### 核心功能

- **好友聊天**：用户可以与已添加的好友进行一对一聊天
- **消息管理**：支持发送、接收、查看聊天消息
- **会话管理**：自动创建和管理聊天会话
- **未读提醒**：实时显示未读消息数量和提醒
- **消息状态**：支持消息已读/未读状态管理
- **实时更新**：消息实时推送和好友数量实时更新
- **智能会话**：自动创建新聊天会话

### 界面特性

- **现代化设计**：采用深色主题，符合游戏风格
- **响应式布局**：适配不同屏幕尺寸
- **实时头像**：正确显示用户头像
- **智能时间**：友好的时间显示格式
- **流畅交互**：优化的用户体验
- **QQ风格布局**：自己消息头像在右边，对方消息头像在左边
- **加载动画**：消息和会话列表加载时的动画效果

## 🗄️ 数据库设计

### 表结构

#### 1. 聊天会话表 (`chat_conversations`)

```sql
CREATE TABLE `chat_conversations` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '会话ID',
  `user1_id` varchar(50) NOT NULL COMMENT '用户1ID',
  `user2_id` varchar(50) NOT NULL COMMENT '用户2ID',
  `last_message_id` int(11) DEFAULT NULL COMMENT '最后一条消息ID',
  `last_message_time` datetime DEFAULT NULL COMMENT '最后消息时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_conversation` (`user1_id`,`user2_id`),
  KEY `idx_user1_id` (`user1_id`),
  KEY `idx_user2_id` (`user2_id`),
  KEY `idx_last_message_time` (`last_message_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='聊天会话表';
```

#### 2. 聊天消息表 (`chat_messages`)

```sql
CREATE TABLE `chat_messages` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '消息ID',
  `conversation_id` int(11) NOT NULL COMMENT '会话ID',
  `sender_id` varchar(50) NOT NULL COMMENT '发送者ID',
  `receiver_id` varchar(50) NOT NULL COMMENT '接收者ID',
  `message_type` enum('text','image','file') NOT NULL DEFAULT 'text' COMMENT '消息类型',
  `content` text NOT NULL COMMENT '消息内容',
  `is_read` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已读',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_conversation_id` (`conversation_id`),
  KEY `idx_sender_id` (`sender_id`),
  KEY `idx_receiver_id` (`receiver_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_is_read` (`is_read`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='聊天消息表';
```

### 外键约束

- 会话表与用户表关联
- 消息表与会话表、用户表关联
- 支持级联删除，确保数据一致性

## 🔧 后端API设计

### API端点

#### 1. 获取聊天会话列表

```
GET /api/chat/conversations
```

**功能**：获取当前用户的所有聊天会话

**请求头**：

```
Authorization: Bearer <token>
```

**响应示例**：

```json
{
  "success": true,
  "data": [
    {
      "conversationId": 1,
      "friendId": "user_123",
      "friendUsername": "阿酒",
      "friendNickname": "阿酒",
      "friendAvatar": "data:image/jpeg;base64,/9j/4AAQ...",
      "friendUid": 666,
      "lastMessage": {
        "content": "你好！",
        "type": "text",
        "createdAt": "2025-10-11T10:00:00.000Z",
        "isRead": false
      },
      "lastMessageTime": "2025-10-11T10:00:00.000Z",
      "unreadCount": 2
    }
  ]
}
```

#### 2. 获取会话消息列表

```
GET /api/chat/messages/:conversationId?page=1&limit=50
```

**功能**：获取指定会话的消息列表

**参数**：

- `conversationId`：会话ID
- `page`：页码（可选，默认1）
- `limit`：每页数量（可选，默认50）

**响应示例**：

```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "senderId": "user_123",
      "receiverId": "admin_001",
      "messageType": "text",
      "content": "你好！",
      "isRead": true,
      "createdAt": "2025-10-11T10:00:00.000Z",
      "senderUsername": "阿酒",
      "senderNickname": "阿酒",
      "senderAvatar": "data:image/jpeg;base64,/9j/4AAQ...",
      "isOwn": false
    }
  ]
}
```

#### 3. 发送消息

```
POST /api/chat/send
```

**功能**：发送聊天消息

**请求体**：

```json
{
  "receiverId": "user_123",
  "messageType": "text",
  "content": "你好！"
}
```

**响应示例**：

```json
{
  "success": true,
  "message": "消息发送成功",
  "data": {
    "messageId": 1,
    "conversationId": 1,
    "senderId": "admin_001",
    "receiverId": "user_123",
    "messageType": "text",
    "content": "你好！",
    "createdAt": "2025-10-11T10:00:00.000Z",
    "senderUsername": "admin",
    "senderNickname": "admin",
    "senderAvatar": "data:image/jpeg;base64,/9j/4AAQ...",
    "isOwn": true
  }
}
```

#### 4. 标记消息为已读

```
POST /api/chat/mark-read
```

**功能**：标记指定会话的消息为已读

**请求体**：

```json
{
  "conversationId": 1
}
```

**响应示例**：

```json
{
  "success": true,
  "message": "消息已标记为已读"
}
```

#### 5. 获取未读消息数量

```
GET /api/chat/unread-count
```

**功能**：获取当前用户的未读消息总数

**响应示例**：

```json
{
  "success": true,
  "data": {
    "unreadCount": 5
  }
}
```

#### 6. 创建新会话

```
POST /api/chat/create-conversation
```

**功能**：为两个好友创建新的聊天会话

**请求体**：

```json
{
  "friendId": "user_123"
}
```

**响应示例**：

```json
{
  "success": true,
  "message": "会话创建成功",
  "data": {
    "conversationId": 1
  }
}
```

### 安全特性

#### 权限验证

- **身份验证**：所有API都需要有效的JWT token
- **好友验证**：只能向已添加的好友发送消息
- **会话权限**：用户只能访问自己的聊天会话
- **数据隔离**：确保用户数据安全隔离

#### 数据验证

- **输入验证**：验证消息内容和接收者ID
- **类型检查**：支持文本、图片、文件等消息类型
- **长度限制**：防止过长的消息内容

## 🎨 前端界面设计

### 组件结构

#### 主组件：`UserChat.vue`

- **位置**：`frontend/src/components/user/UserChat.vue`
- **功能**：聊天功能的主界面组件

#### 界面布局

##### 1. 聊天侧边栏

- **会话列表**：显示所有聊天会话
- **好友信息**：显示好友头像、昵称、UID
- **未读提醒**：显示未读消息数量和红点
- **最后消息**：显示最后一条消息的预览
- **时间显示**：显示最后消息时间

##### 2. 聊天主区域

- **聊天头部**：显示当前聊天对象信息
- **消息列表**：显示聊天消息历史
- **消息输入**：支持多行文本输入
- **发送按钮**：发送消息按钮

### 界面特性

#### 视觉设计

- **深色主题**：符合游戏风格的设计
- **渐变背景**：现代化的视觉效果
- **发光边框**：科技感的界面元素
- **响应式布局**：适配不同屏幕尺寸

#### 交互体验

- **实时更新**：自动刷新会话和消息（每5秒轮询新消息）
- **智能滚动**：新消息自动滚动到底部
- **键盘支持**：Enter键快速发送消息
- **状态反馈**：发送状态和错误提示
- **自动会话创建**：点击没有聊天记录的好友时自动创建会话
- **好友数量实时更新**：每30秒更新好友数量统计

#### 消息显示

- **发送者区分**：自己的消息和对方的消息样式不同
- **头像显示**：每条消息显示发送者头像
- **时间格式**：智能时间显示（刚刚、几分钟前等）
- **消息气泡**：现代化的消息气泡设计
- **QQ风格布局**：自己消息头像在消息框右边，对方消息头像在消息框左边
- **加载状态**：消息和会话列表加载时显示动画效果

## 🚀 使用指南

### 数据库初始化

#### 1. 执行SQL脚本

```bash
# 在MySQL数据库中执行
mysql -u root -p fivem_website < backend/database/chat_tables.sql
```

#### 2. 验证表结构

```sql
-- 检查表是否创建成功
SHOW TABLES LIKE 'chat_%';

-- 检查表结构
DESCRIBE chat_conversations;
DESCRIBE chat_messages;
```

### 功能使用

#### 1. 开始聊天

1. 在"好友管理"中添加好友
2. 切换到"聊天"标签页
3. 在左侧会话列表中选择好友
4. 开始发送消息

#### 2. 发送消息

1. 在消息输入框中输入内容
2. 按Enter键或点击发送按钮
3. 消息会立即显示在聊天界面中

#### 3. 查看历史消息

1. 选择会话后自动加载历史消息
2. 支持分页加载更多历史消息
3. 消息按时间顺序显示

#### 4. 管理未读消息

1. 有新消息时会显示未读数量
2. 点击会话后自动标记为已读
3. 可以手动标记消息为已读

## 🔍 技术实现

### 后端技术栈

- **Node.js + Express**：API服务器框架
- **MySQL**：关系型数据库
- **JWT**：身份验证
- **事务处理**：确保数据一致性

### 前端技术栈

- **Vue 3**：前端框架
- **Composition API**：现代化的组件开发
- **响应式设计**：适配不同设备
- **实时更新**：定时刷新机制
- **轮询机制**：消息和好友数量实时更新
- **响应式数据**：使用ref和computed管理状态

### 关键技术点

#### 1. 数据库设计

- **会话管理**：自动创建和管理聊天会话
- **消息存储**：高效的消息存储和检索
- **索引优化**：合理的索引设计提高查询性能
- **外键约束**：确保数据完整性和一致性

#### 2. API设计

- **RESTful风格**：标准的API设计规范
- **错误处理**：完善的错误处理和响应
- **权限控制**：严格的权限验证机制
- **数据验证**：输入数据的验证和清理

#### 3. 前端实现

- **组件化开发**：模块化的组件设计
- **状态管理**：响应式的数据状态管理
- **用户体验**：流畅的交互体验
- **性能优化**：合理的更新频率和缓存策略
- **实时通信**：轮询机制实现准实时消息推送
- **智能布局**：QQ风格的消息布局设计
- **自动会话**：智能创建新聊天会话

## 📊 功能扩展

### 已实现功能

- ✅ 基础文字聊天
- ✅ 会话管理
- ✅ 未读消息提醒
- ✅ 消息状态管理
- ✅ 头像显示
- ✅ 时间格式化
- ✅ 消息实时更新（轮询机制）
- ✅ 自动创建新会话
- ✅ QQ风格消息布局
- ✅ 好友数量实时更新
- ✅ 加载动画效果
- ✅ 智能时间显示（刚刚、X秒前等）

### 可扩展功能

- 🔄 图片消息支持
- 🔄 文件传输功能
- 🔄 消息撤回功能
- 🔄 群聊功能
- 🔄 消息搜索功能
- 🔄 聊天记录导出
- 🔄 消息加密
- 🔄 在线状态显示
- 🔄 消息推送通知
- 🔄 表情包支持

## 🛡️ 安全考虑

### 数据安全

- **权限验证**：严格的用户权限控制
- **数据隔离**：用户数据完全隔离
- **输入验证**：防止恶意输入和注入攻击
- **传输安全**：HTTPS加密传输

### 隐私保护

- **消息加密**：可扩展的消息加密功能
- **数据清理**：支持消息删除和数据清理
- **访问控制**：严格的访问权限控制
- **审计日志**：可扩展的操作日志记录

## 📈 性能优化

### 数据库优化

- **索引设计**：合理的索引提高查询性能
- **分页查询**：避免一次性加载大量数据
- **连接池**：数据库连接池管理
- **查询优化**：高效的SQL查询语句

### 前端优化

- **懒加载**：按需加载聊天数据
- **缓存策略**：合理的数据缓存机制
- **更新频率**：优化的数据更新频率
- **内存管理**：避免内存泄漏

## 🔧 维护指南

### 日常维护

- **数据备份**：定期备份聊天数据
- **性能监控**：监控API响应时间
- **错误日志**：关注错误日志和异常
- **用户反馈**：收集用户使用反馈

### 故障排除

- **数据库连接**：检查数据库连接状态
- **API响应**：验证API接口响应
- **前端错误**：检查浏览器控制台错误
- **权限问题**：验证用户权限设置

## 📝 更新日志

### v1.1.0 (2025-10-11) - 实时更新和用户体验优化

- ✅ 实现消息实时更新（每5秒轮询）
- ✅ 添加自动创建新会话功能
- ✅ 修复消息布局为QQ风格（自己消息头像在右边）
- ✅ 实现好友数量实时更新（每30秒更新）
- ✅ 添加加载动画效果
- ✅ 优化时间显示（刚刚、X秒前等）
- ✅ 新增创建会话API接口
- ✅ 使用好友统计API优化性能

### v1.0.0 (2025-10-11) - 基础功能实现

- ✅ 实现基础聊天功能
- ✅ 创建数据库表结构
- ✅ 开发后端API接口
- ✅ 实现前端聊天界面
- ✅ 添加未读消息提醒
- ✅ 支持消息状态管理
- ✅ 实现头像显示功能
- ✅ 添加时间格式化显示

---

## 📞 技术支持

如有问题或建议，请联系开发团队或查看相关技术文档。

**开发团队**：幻境FiveM服务器开发组  
**文档版本**：v1.1.0  
**最后更新**：2025年10月11日
