# 游戏日志功能配置指南

## 功能概述

游戏日志功能允许您将FiveM服务器的游戏日志数据同时发送到KOOK和网站管理控制台，方便管理员查看和管理游戏日志。

## 配置步骤

### 1. 后端配置

#### 1.1 环境变量配置
在 `backend/.env` 文件中添加以下配置：

```env
# 游戏日志API密钥（用于FiveM服务器验证）
GAME_LOGS_API_KEY=your_secure_api_key_here
```

**重要提示：** 请将 `your_secure_api_key_here` 替换为一个安全的随机字符串，建议使用32位以上的随机字符。

#### 1.2 数据库初始化
游戏日志功能需要创建新的数据库表。有两种方式：

**方式一：使用独立SQL文件（推荐）**
```bash
# 在MySQL中执行
mysql -u your_username -p your_database < backend/database/game_logs.sql
```

**方式二：手动执行SQL**
```sql
-- 创建游戏日志表（简化版）
CREATE TABLE IF NOT EXISTS `game_logs` (
  `id` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '日志ID',
  `log_type` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '日志主类型（如：银行记录、背包记录）',
  `log_category` varchar(100) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '日志子类型（如：存款、取款、丢弃、转移）',
  `raw_content` text COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '原始日志内容',
  `server_time` datetime NOT NULL COMMENT '服务器时间',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏日志表';

-- 添加主键和索引
ALTER TABLE `game_logs` 
  ADD PRIMARY KEY (`id`),
  ADD KEY `idx_log_type` (`log_type`),
  ADD KEY `idx_log_category` (`log_category`),
  ADD KEY `idx_server_time` (`server_time`),
  ADD KEY `idx_created_at` (`created_at`),
  ADD KEY `idx_log_type_category` (`log_type`, `log_category`),
  ADD KEY `idx_type_time` (`log_type`, `server_time`);
```

### 2. FiveM服务器配置

#### 2.1 修改Qy_Logs配置
在 `Qy_Logs/Config.lua` 文件中，更新网站API配置：

```lua
--网站API配置
Config.WebsiteAPI = {
    URL = "http://your-website-domain.com:3002", -- 替换为您的网站域名和端口
    API_KEY = "your_secure_api_key_here" -- 与后端.env中的GAME_LOGS_API_KEY保持一致
}
```

**配置说明：**
- `URL`: 您的网站API地址，如果使用域名，请确保FiveM服务器能够访问
- `API_KEY`: 必须与后端环境变量中的 `GAME_LOGS_API_KEY` 保持一致

#### 2.2 重启FiveM服务器
修改配置后，需要重启FiveM服务器以使配置生效。

### 3. 功能验证

#### 3.1 检查API连接
1. 启动后端服务器
2. 在FiveM服务器中触发一个日志事件（如丢弃物品）
3. 检查后端控制台是否显示 "✅ 游戏日志已发送到网站API" 消息
4. 检查数据库中是否新增了日志记录

#### 3.2 检查前端界面
1. 登录管理控制台
2. 点击 "游戏日志" 标签页
3. 查看是否显示日志数据和统计信息

## 功能特性

### 1. 日志类型支持

#### 1.1 金钱交易类
- 银行记录
- 账单记录
- 改名系统

#### 1.2 服务器奖励类
- 在线商店
- 每日签到
- 玩家挂机

#### 1.3 模型类
- 人物模型

#### 1.4 警局系统类
- 社区服务
- 监狱系统
- 通缉系统

#### 1.5 物品交易类
- 系统回收站

#### 1.6 背包库存类
- 第二背包
- 主背包扩容

#### 1.7 OX背包记录类
- 丢弃记录
- 替换记录
- 转移记录
- 给予记录
- 管理员操作
- 物品使用
- 其他插件添加记录

#### 1.8 其他类型
- 聊天记录
- 通用封禁日志
- 道具、车辆、角色（Peds）
- 未白名单的道具
- 粒子效果、爆炸、声音、电击枪刷屏
- 黑名单词汇
- 触发器相关日志
- Lua 菜单检测
- 瞄准滥用检测
- 截图相关日志
- 黑名单按键检测
- 基础日志

### 2. 管理功能
- 日志查看和搜索
- 按类型、分类、玩家筛选
- 时间范围筛选
- 批量删除
- 日志详情查看
- 统计信息展示

### 3. 数据解析
系统会自动解析日志内容中的以下信息：
- 时间戳
- 玩家ID和名称
- 物品信息和数量
- 坐标信息
- 元数据

### 4. 日志调用方式
在FiveM脚本中，使用以下方式调用日志功能：

```lua
-- 基本调用格式
exports.Qy_Logs:Yz('主类型', '子类型', '日志内容')

-- 示例：
exports.Qy_Logs:Yz('银行记录', '存款', '[时间: 2025-01-16 10:30:00][玩家ID: 123][玩家名: 张三][金额: 10000]')
exports.Qy_Logs:Yz('银行记录', '取款', '[时间: 2025-01-16 10:30:00][玩家ID: 123][玩家名: 张三][金额: 5000]')
exports.Qy_Logs:Yz('背包记录', '丢弃', '[时间: 2025-01-16 10:30:00][玩家ID: 123][玩家名: 张三][物品: money|现金][数量: 1000个]')
exports.Qy_Logs:Yz('背包记录', '转移', '[时间: 2025-01-16 10:30:00][玩家ID: 123][玩家名: 张三][物品: weapon|武器][数量: 1个]')
exports.Qy_Logs:Yz('警局系统', '逮捕', '[时间: 2025-01-16 10:30:00][玩家ID: 123][玩家名: 张三][原因: 超速驾驶]')
```

**参数说明：**
- **第一个参数（主类型）**：日志的主要分类（如：银行记录、背包记录、警局系统等）
- **第二个参数（子类型）**：具体的操作类型（如：存款、取款、丢弃、转移、逮捕等）
- **第三个参数（日志内容）**：具体的日志内容（包含各种字段信息）

**主类型建议：**
- `银行记录` - 所有银行相关操作
- `背包记录` - 所有背包/库存相关操作
- `警局系统` - 所有警局相关操作
- `交易记录` - 所有交易相关操作
- `系统记录` - 系统级别的操作记录

## 故障排除

### 1. 日志未显示在网站
**可能原因：**
- API密钥不匹配
- 网络连接问题
- 后端服务未启动

**解决方法：**
1. 检查API密钥配置是否一致
2. 检查网络连接
3. 查看后端控制台错误信息

### 2. 数据库错误
**可能原因：**
- 数据库表未创建
- 权限不足

**解决方法：**
1. 执行数据库初始化SQL
2. 检查数据库用户权限

### 3. 前端显示异常
**可能原因：**
- API接口错误
- 权限不足

**解决方法：**
1. 检查浏览器控制台错误
2. 确认用户具有管理员权限

## 安全注意事项

1. **API密钥安全**：请使用强密码作为API密钥，并定期更换
2. **网络安全**：建议在生产环境中使用HTTPS
3. **访问控制**：确保只有授权用户能够访问管理控制台
4. **数据备份**：定期备份游戏日志数据

## 性能优化建议

1. **数据清理**：定期清理旧的日志数据以保持性能
2. **索引优化**：根据查询模式调整数据库索引
3. **分页查询**：使用分页避免一次性加载大量数据
4. **缓存策略**：对统计数据使用缓存提高响应速度

## 扩展功能

未来可以考虑添加以下功能：
- 日志导出功能
- 实时日志推送
- 日志分析报告
- 自定义日志类型
- 日志告警系统
