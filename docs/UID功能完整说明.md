# UID功能完整说明文档

## 概述

UID（User ID）是一个纯数字的用户唯一标识符，用于进一步区分用户。与现有的字符串ID不同，UID是纯数字组合，便于用户间识别和记忆。

## 功能特点

- **8位数字格式**：UID由8位纯数字组成，如：10000001, 10000002, 10000003...
- **唯一性**：每个用户拥有唯一的UID，不会重复
- **自动生成**：注册时自动分配，用户无法修改
- **递增分配**：从10000000开始，按注册顺序递增分配
- **黑名单机制**：避免分配特殊数字组合（如重复数字、连续数字等）
- **公开显示**：UID可以公开显示，用于用户间识别

## 数据库结构

### users表新增字段

```sql
-- 添加uid字段（8位数）
ALTER TABLE `users` ADD COLUMN `uid` int(11) NOT NULL COMMENT '用户唯一数字ID（8位数）' AFTER `id`;
ALTER TABLE `users` ADD UNIQUE KEY `unique_uid` (`uid`);
ALTER TABLE `users` ADD KEY `idx_uid` (`uid`);

-- 创建uid黑名单表
CREATE TABLE `uid_blacklist` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uid` int(11) NOT NULL COMMENT '被禁止的UID',
  `reason` varchar(255) DEFAULT NULL COMMENT '禁止原因',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_blacklist_uid` (`uid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='UID黑名单表';
```

## 黑名单机制

### 黑名单规则

系统会自动避免分配以下类型的UID：

1. **重复数字组合**：如 11111111, 22222222, 88888888 等
2. **连续数字组合**：如 12345678, 87654321 等
3. **特殊数字组合**：如 12345679, 98765432 等
4. **系统保留UID**：如 10000000（起始UID）, 99999999（最大UID）等

### 黑名单管理

- **自动添加**：系统预置了常见的黑名单UID
- **手动管理**：管理员可以通过API添加或移除黑名单UID
- **实时检查**：生成UID时会实时检查黑名单，确保不会分配被禁止的UID

---

# 第一次迭代：用户UID显示功能

## 迭代目标

让用户在前端能够清楚地看到自己的UID，并能够方便地复制分享。

## ✅ 已完成的改进

### 1. 用户控制台总览页面

- **位置**：用户控制台 → 总览标签页
- **显示内容**：在用户信息卡片中显示UID
- **样式特点**：
  - 使用等宽字体（Courier New）显示，便于识别
  - 带有背景色和边框，突出显示
  - 鼠标悬停时有动画效果

### 2. 可点击复制功能

- **交互方式**：点击UID即可复制到剪贴板
- **视觉反馈**：
  - 鼠标悬停时显示复制图标（📋）
  - 复制成功后显示成功图标（✅）
  - 2秒后自动恢复原始状态
- **兼容性**：支持现代浏览器的Clipboard API，并提供降级方案

### 3. 用户体验优化

- **提示信息**：鼠标悬停时显示"点击复制UID: xxxxxxxx"
- **错误处理**：如果UID不存在，显示"未知"
- **响应式设计**：在移动端也能正常显示和操作

### 4. 用户查找功能头像修复

- **问题**：用户查找功能没有正确返回头像
- **解决方案**：更新后端用户查找API，正确处理头像数据（转换为Base64或保持URL格式）
- **效果**：用户查找时能正确显示其他用户的头像

---

# 第二次迭代：站长UID编辑功能

## 迭代目标

为站长控制台的用户管理模块添加编辑用户UID功能，允许站长随意编辑用户的UID，不受黑名单和其他限制。

## ✅ 已完成的功能

### 1. 前端功能增强

#### 用户管理界面更新

- **位置**：站长控制台 → 用户管理 → 编辑用户
- **新增字段**：UID编辑输入框（仅站长可见）
- **权限控制**：只有站长（role=1）才能看到和编辑UID字段
- **输入验证**：
  - 必须是纯数字
  - 长度限制：1-20位数字
  - 实时验证和错误提示

#### 权限检查机制

- **前端权限检查**：通过`isSiteOwner`变量控制UID编辑字段的显示
- **用户角色识别**：从localStorage获取用户信息，检查role是否为1
- **动态显示**：非站长用户无法看到UID编辑功能

### 2. 后端功能增强

#### API权限控制

- **路由保护**：`PUT /api/users/:id` 接口已支持UID编辑
- **权限验证**：只有站长（role=1）才能修改用户UID
- **错误处理**：非站长尝试修改UID时返回403错误

#### UID验证逻辑

- **格式验证**：必须是纯数字（使用正则表达式`/^\d+$/`）
- **唯一性检查**：确保新UID未被其他用户使用
- **无黑名单限制**：站长可以设置任何数字组合的UID
- **无长度限制**：支持1-20位数字（可根据需要调整）

#### 数据库更新

- **字段更新**：直接更新users表的uid字段
- **事务安全**：确保UID更新的原子性
- **时间戳更新**：自动更新updated_at字段

### 3. 用户体验优化

#### 界面设计

- **清晰的权限提示**：显示"站长权限：可编辑用户UID，不受黑名单限制，但必须是纯数字"
- **实时验证反馈**：输入时即时显示验证结果
- **错误信息明确**：具体的错误提示帮助用户理解问题

#### 操作流程

1. 站长登录并进入用户管理
2. 点击编辑用户按钮
3. 在编辑表单中看到UID编辑字段
4. 输入新的UID（纯数字）
5. 系统验证并保存

## 🔧 技术实现细节

### 前端实现

```javascript
// 权限检查
const isSiteOwner = ref(false)
const user = JSON.parse(localStorage.getItem('user') || '{}')
isSiteOwner.value = user.role === 1

// UID验证
if (isSiteOwner.value && editForm.value.uid) {
  if (!/^\d+$/.test(editForm.value.uid)) {
    errors.uid = 'UID必须是纯数字'
  }
}
```

### 后端实现

```javascript
// 权限检查
if (uid !== undefined && uid !== existingUser[0].uid) {
  if (currentUserRole !== 1) {
    return res.status(403).json({
      success: false,
      message: '只有站长才能修改用户UID'
    })
  }
  
  // UID验证
  if (!/^\d+$/.test(uid)) {
    return res.status(400).json({
      success: false,
      message: 'UID必须是纯数字'
    })
  }
}
```

## 📋 功能特点

### 权限特点

- **最高权限**：只有站长可以编辑UID
- **无限制编辑**：不受黑名单限制
- **灵活长度**：支持1-20位数字

### 安全特点

- **权限验证**：前后端双重权限检查
- **唯一性保证**：确保UID不重复
- **格式验证**：严格的数字格式要求

### 用户体验

- **直观界面**：清晰的权限提示
- **实时反馈**：即时验证结果
- **错误处理**：友好的错误信息

## 🎯 使用场景

1. **特殊用户管理**：为VIP用户分配特殊UID
2. **系统维护**：修复UID冲突或错误
3. **个性化服务**：为用户分配有意义的UID
4. **数据迁移**：从其他系统迁移用户时保持UID

## 🔄 后续扩展可能

1. **批量UID编辑**：支持批量修改多个用户的UID
2. **UID历史记录**：记录UID变更历史
3. **UID模板**：预设常用的UID格式
4. **导入导出**：支持UID的批量导入导出

## 📊 测试建议

1. **权限测试**：验证非站长无法看到UID编辑功能
2. **验证测试**：测试各种无效UID的验证
3. **唯一性测试**：测试重复UID的处理
4. **界面测试**：验证UI在不同权限下的显示

## 📍 UID显示位置总结

1. **用户控制台总览页面**：主要显示位置，带有复制功能
2. **用户资料页面**：在基本信息中显示（只读）
3. **用户仪表板头部**：在用户详细信息中显示
4. **用户查找功能**：支持通过UID查找其他用户
5. **站长控制台用户管理**：编辑用户时显示和修改UID

## 🎯 总结

UID功能现在已经完全实现，包括：

1. **基础功能**：8位数字UID自动生成和显示
2. **黑名单机制**：避免分配特殊数字组合
3. **用户界面**：清晰的UID显示和复制功能
4. **查找功能**：通过UID查找其他用户
5. **管理功能**：站长可以编辑任何用户的UID

这个功能为用户身份识别提供了更加专业和便捷的方式，同时为系统管理提供了强大的工具。
