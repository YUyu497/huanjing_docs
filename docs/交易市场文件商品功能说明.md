# 交易市场文件商品功能说明

## 功能概述

交易市场现在支持为现有商品类型（头像框、徽章、游戏道具、VIP特权等）上传压缩文件。任何商品类型都可以以文件的形式存在，用户可以购买并下载相应的文件。

## 主要功能

### 1. 文件商品上传
- **支持格式**：ZIP, RAR, 7Z, TAR, GZ
- **文件大小限制**：最大100MB
- **上传位置**：管理员后台
- **存储方式**：本地存储 + 七牛云存储（可选）

### 2. 文件商品展示
- 在交易市场页面显示带文件的商品
- 显示文件名称、大小、下载次数等信息
- 支持按商品类型筛选（游戏赞助物品、网站专属物品、FiveM插件、FiveM地图、FiveM车包）

### 3. 文件商品购买
- 用户可以使用积分购买文件商品
- 购买后获得下载权限
- 支持下载次数限制（可选）

### 4. 文件下载
- 购买后可以下载文件
- 记录下载日志
- 支持下载次数统计

## 数据库变更

### 新增字段
在 `points_products` 表中新增以下字段：
- `file_name` - 存储文件名
- `file_original_name` - 原始文件名
- `file_size` - 文件大小（字节）
- `file_type` - 文件MIME类型
- `file_url` - 本地文件URL
- `file_oss_url` - 七牛云文件URL
- `file_category` - 文件分类
- `download_count` - 下载次数
- `max_downloads` - 最大下载次数限制
- `uploaded_by` - 上传者用户ID

### 新增表
- `points_product_downloads` - 文件下载记录表

### 枚举更新
- 更新 `product_type` 枚举为：`game_sponsor`（游戏赞助物品）、`website_exclusive`（网站专属物品）、`fivem_plugin`（FiveM插件）、`fivem_map`（FiveM地图）、`fivem_vehicle`（FiveM车包）

## API接口

### 管理员接口
- `POST /api/admin/points/products/file` - 上传文件商品

### 用户接口
- `GET /api/points/products/:id/download` - 下载文件商品

## 使用流程

### 管理员上传文件商品
1. 进入管理员后台
2. 选择"文件商品上传"功能
3. 选择压缩文件（ZIP、RAR、7Z等）
4. 选择商品类型（游戏赞助物品、网站专属物品、FiveM插件、FiveM地图、FiveM车包）
5. 填写商品信息（名称、描述、积分消耗等）
6. 设置下载次数限制（可选）
7. 提交上传

### 用户购买和下载
1. 在交易市场浏览文件商品
2. 查看文件信息（名称、大小、下载次数等）
3. 使用积分购买商品
4. 购买成功后显示"下载文件"按钮
5. 点击下载按钮获取文件

## 安全特性

1. **文件类型限制**：只允许上传压缩文件
2. **文件大小限制**：最大100MB
3. **权限验证**：只有购买者才能下载
4. **下载记录**：记录所有下载行为
5. **次数限制**：支持设置最大下载次数

## 部署说明

### 数据库迁移
执行以下SQL脚本更新数据库结构：
```bash
mysql -u username -p database_name < backend/scripts/add-file-product-support.sql
```

### 文件存储配置
确保以下目录存在且有写入权限：
- `backend/uploads/marketplace/` - 本地文件存储目录

### 环境变量
确保以下环境变量已配置：
- `MAX_FILE_SIZE` - 最大文件大小（默认10MB，建议设置为100MB）
- `ALLOWED_FILE_TYPES` - 允许的文件类型

## 注意事项

1. **文件安全**：上传的文件会存储在服务器上，请确保服务器安全
2. **存储空间**：文件会占用服务器存储空间，建议定期清理
3. **下载速度**：大文件下载可能较慢，建议使用CDN加速
4. **备份**：重要文件建议定期备份

## 扩展功能

### 可扩展的功能
1. **文件预览**：支持在线预览压缩文件内容
2. **版本管理**：支持文件版本更新
3. **批量上传**：支持批量上传多个文件
4. **文件分类**：支持更详细的文件分类
5. **下载统计**：更详细的下载统计和分析

### 集成建议
1. **CDN加速**：集成CDN服务提高下载速度
2. **病毒扫描**：集成病毒扫描服务
3. **文件加密**：对敏感文件进行加密存储
4. **访问控制**：更细粒度的访问权限控制
