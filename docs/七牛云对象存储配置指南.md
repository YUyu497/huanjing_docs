# 七牛云对象存储配置指南

## 概述

本项目已集成七牛云对象存储服务，支持文件上传、下载、删除等操作。系统会自动根据配置选择存储方式：七牛云 > 阿里云OSS > 本地存储。

## 配置步骤

### 1. 安装依赖

```bash
cd backend
npm install qiniu
```

### 2. 获取七牛云配置信息

1. 登录 [七牛云控制台](https://portal.qiniu.com/)
2. 进入 **对象存储** > **空间管理**
3. 创建或选择一个存储空间（Bucket）
4. 获取以下信息：
   - Access Key
   - Secret Key
   - 存储空间名称
   - 访问域名

### 3. 配置环境变量

在 `backend/.env` 文件中添加以下配置：

```env
# 七牛云对象存储配置
QINIU_ENABLED=true
QINIU_ACCESS_KEY=your-qiniu-access-key
QINIU_SECRET_KEY=your-qiniu-secret-key
QINIU_BUCKET_NAME=your-qiniu-bucket-name
QINIU_DOMAIN=https://your-domain.com
QINIU_REGION=z0
QINIU_PRIVATE=false
```

### 4. 配置说明

| 配置项 | 说明 | 您的配置值 | 示例值 |
|--------|------|------------|--------|
| `QINIU_ENABLED` | 是否启用七牛云 | `true` | `true` |
| `QINIU_ACCESS_KEY` | 七牛云Access Key | 需要获取 | `your-access-key` |
| `QINIU_SECRET_KEY` | 七牛云Secret Key | 需要获取 | `your-secret-key` |
| `QINIU_BUCKET_NAME` | 存储空间名称 | `huanjing-downloads` | `huanjing-downloads` |
| `QINIU_DOMAIN` | 访问域名 | `https://qiniu.ajiu.top` | `https://qiniu.ajiu.top` |
| `QINIU_REGION` | 存储区域 | `z2` (华南-广东) | `z2` |
| `QINIU_PRIVATE` | 是否为私有空间 | `true` | `true` |

### 5. 您的具体配置

根据您的七牛云控制台信息，请在 `backend/.env` 文件中添加：

```env
# 七牛云对象存储配置 - 基于您的实际配置
QINIU_ENABLED=true
QINIU_ACCESS_KEY=your-qiniu-access-key
QINIU_SECRET_KEY=your-qiniu-secret-key
QINIU_BUCKET_NAME=huanjing-downloads
QINIU_DOMAIN=https://qiniu.ajiu.top
QINIU_REGION=z2
QINIU_PRIVATE=true
```

**注意**: 您需要从七牛云控制台获取 Access Key 和 Secret Key。

### 5. 存储区域代码

| 区域 | 代码 | 说明 |
|------|------|------|
| 华东 | `z0` | 默认区域 |
| 华北 | `z1` | 北京 |
| 华南 | `z2` | 广东 |
| 北美 | `na0` | 美国 |
| 东南亚 | `as0` | 新加坡 |

## 功能特性

### 1. 自动存储选择

系统按以下优先级选择存储方式：

1. **七牛云** - 如果 `QINIU_ENABLED=true` 且配置完整
2. **阿里云OSS** - 如果 `OSS_ENABLED=true` 且配置完整
3. **本地存储** - 默认方式

### 2. 支持的操作

- ✅ 文件上传（单文件/多文件）
- ✅ 文件下载
- ✅ 文件删除
- ✅ 文件存在性检查
- ✅ 获取文件信息
- ✅ 生成私有下载链接
- ✅ 批量删除文件
- ✅ 获取文件列表

### 3. 上传流程

1. 文件通过 multer 临时保存到本地
2. 调用七牛云API上传到云端
3. 上传成功后删除本地临时文件
4. 返回云端文件URL

## API接口

### 上传单个文件

```http
POST /api/upload/single
Content-Type: multipart/form-data

file: [文件]
```

响应示例：

```json
{
  "success": true,
  "message": "文件上传成功",
  "data": {
    "filename": "file-1234567890.jpg",
    "originalName": "image.jpg",
    "size": 1024000,
    "mimetype": "image/jpeg",
    "url": "https://cdn.example.com/file-1234567890.jpg",
    "storageType": "qiniu"
  }
}
```

### 上传多个文件

```http
POST /api/upload/multiple
Content-Type: multipart/form-data

files: [文件1, 文件2, ...]
```

### 删除文件

```http
DELETE /api/upload/:filename
```

### 获取存储状态

```http
GET /api/upload/status
```

响应示例：

```json
{
  "success": true,
  "data": {
    "storageType": "qiniu",
    "isConfigured": true,
    "uploadPath": "uploads",
    "maxFileSize": "10MB",
    "allowedTypes": ["jpg", "jpeg", "png", "gif", "webp", "pdf", "zip", "rar"]
  }
}
```

## 安全配置

### 1. 访问控制

- 设置存储空间为公开或私有
- 配置防盗链规则
- 设置访问域名白名单

### 2. 上传策略

- 限制文件类型
- 限制文件大小
- 设置上传过期时间
- 配置回调通知

### 3. 私有访问

如果存储空间设置为私有，系统会自动生成带签名的访问URL：

```javascript
// 生成1小时有效的私有下载链接
const privateUrl = await qiniuService.generatePrivateUrl('filename.jpg', 3600)
```

## 常见问题

### 1. 上传失败

**问题**：文件上传到七牛云失败
**解决方案**：

- 检查Access Key和Secret Key是否正确
- 确认存储空间名称正确
- 检查网络连接
- 查看服务器日志获取详细错误信息

### 2. 访问域名问题

**问题**：文件URL无法访问
**解决方案**：

- 确认域名已正确配置
- 检查域名是否已备案（国内）
- 确认CDN加速域名配置正确

### 3. 存储区域选择

**问题**：上传速度慢
**解决方案**：

- 选择距离用户最近的存储区域
- 启用CDN加速
- 使用传输加速功能

## 监控和日志

### 1. 日志记录

系统会记录以下操作日志：

- 文件上传成功/失败
- 文件删除操作
- 配置初始化状态
- 错误信息详情

### 2. 监控指标

建议监控以下指标：

- 上传成功率
- 下载响应时间
- 存储使用量
- 流量消耗

## 最佳实践

### 1. 文件命名

- 使用时间戳避免文件名冲突
- 添加随机字符串提高安全性
- 保持原始文件扩展名

### 2. 错误处理

- 实现重试机制
- 提供友好的错误提示
- 记录详细错误日志

### 3. 性能优化

- 启用CDN加速
- 使用分片上传大文件
- 压缩图片文件
- 设置合适的缓存策略

## 技术支持

如遇到问题，请：

1. 查看服务器日志
2. 检查七牛云控制台
3. 参考 [七牛云官方文档](https://developer.qiniu.com/kodo/8596/development-guidelines)
4. 联系技术支持团队
