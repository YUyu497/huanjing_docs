# 游戏日志数据库安装说明

## 概述

本文档说明如何为游戏日志功能安装和配置数据库表。

## 安装步骤

### 1. 使用独立SQL文件安装（推荐）

#### 1.1 通过命令行安装
```bash
# 进入项目目录
cd /path/to/your/project

# 执行SQL文件
mysql -u your_username -p your_database < backend/database/game_logs.sql
```

#### 1.2 通过phpMyAdmin安装
1. 登录phpMyAdmin
2. 选择您的数据库
3. 点击"导入"标签页
4. 选择 `backend/database/game_logs.sql` 文件
5. 点击"执行"

#### 1.3 通过MySQL Workbench安装
1. 打开MySQL Workbench
2. 连接到您的数据库
3. 打开 `backend/database/game_logs.sql` 文件
4. 执行SQL脚本

### 2. 手动创建表

如果无法使用SQL文件，可以手动执行以下SQL语句：

```sql
-- 创建游戏日志表
CREATE TABLE IF NOT EXISTS `game_logs` (
  `id` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '日志ID',
  `log_type` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '日志主类型（如：银行记录、背包记录）',
  `log_category` varchar(100) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '日志子类型（如：存款、取款、丢弃、转移）',
  `player_id` int(11) DEFAULT NULL COMMENT '玩家ID',
  `player_name` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '玩家名称',
  `player_identifier` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '玩家标识符',
  `item_name` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '物品名称',
  `item_label` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '物品标签',
  `item_count` int(11) DEFAULT NULL COMMENT '物品数量',
  `item_slot` int(11) DEFAULT NULL COMMENT '物品槽位',
  `drop_id` varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '掉落ID',
  `coordinates` varchar(200) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '坐标信息',
  `metadata` json DEFAULT NULL COMMENT '元数据（存储其他解析的字段）',
  `raw_content` text COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '原始日志内容',
  `server_time` datetime NOT NULL COMMENT '服务器时间',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏日志表';

-- 添加主键
ALTER TABLE `game_logs` ADD PRIMARY KEY (`id`);

-- 添加索引
ALTER TABLE `game_logs` 
  ADD KEY `idx_log_type` (`log_type`),
  ADD KEY `idx_log_category` (`log_category`),
  ADD KEY `idx_player_id` (`player_id`),
  ADD KEY `idx_player_name` (`player_name`),
  ADD KEY `idx_server_time` (`server_time`),
  ADD KEY `idx_created_at` (`created_at`),
  ADD KEY `idx_log_type_category` (`log_type`, `log_category`),
  ADD KEY `idx_player_time` (`player_id`, `server_time`),
  ADD KEY `idx_type_time` (`log_type`, `server_time`),
  ADD KEY `idx_category_time` (`log_category`, `server_time`);
```

## 验证安装

### 1. 检查表是否创建成功
```sql
-- 查看表结构
DESCRIBE game_logs;

-- 查看索引
SHOW INDEX FROM game_logs;
```

### 2. 检查表权限
确保您的数据库用户对 `game_logs` 表有以下权限：
- SELECT
- INSERT
- UPDATE
- DELETE

## 表结构说明

### 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | varchar(50) | 日志唯一标识符 |
| log_type | varchar(50) | 日志主类型（如：银行记录、背包记录） |
| log_category | varchar(100) | 日志子类型（如：存款、取款、丢弃、转移） |
| player_id | int(11) | 玩家在服务器中的ID |
| player_name | varchar(100) | 玩家名称 |
| player_identifier | varchar(100) | 玩家唯一标识符 |
| item_name | varchar(100) | 物品内部名称 |
| item_label | varchar(100) | 物品显示名称 |
| item_count | int(11) | 物品数量 |
| item_slot | int(11) | 物品槽位 |
| drop_id | varchar(100) | 掉落物品ID |
| coordinates | varchar(200) | 坐标信息 |
| metadata | json | 其他解析的字段 |
| raw_content | text | 原始日志内容 |
| server_time | datetime | 服务器时间 |
| created_at | timestamp | 记录创建时间 |
| updated_at | timestamp | 记录更新时间 |

### 索引说明

| 索引名 | 字段 | 用途 |
|--------|------|------|
| PRIMARY | id | 主键索引 |
| idx_log_type | log_type | 按主类型查询 |
| idx_log_category | log_category | 按子类型查询 |
| idx_player_id | player_id | 按玩家ID查询 |
| idx_player_name | player_name | 按玩家名称查询 |
| idx_server_time | server_time | 按时间查询 |
| idx_created_at | created_at | 按创建时间查询 |
| idx_log_type_category | log_type, log_category | 复合查询 |
| idx_player_time | player_id, server_time | 玩家时间查询 |
| idx_type_time | log_type, server_time | 类型时间查询 |
| idx_category_time | log_category, server_time | 分类时间查询 |

## 性能优化建议

### 1. 定期清理旧数据
```sql
-- 删除30天前的日志（示例）
DELETE FROM game_logs WHERE server_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 2. 分区表（可选）
如果日志量很大，可以考虑按时间分区：
```sql
-- 按月分区（示例）
ALTER TABLE game_logs 
PARTITION BY RANGE (YEAR(server_time) * 100 + MONTH(server_time)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    -- 继续添加分区...
);
```

### 3. 监控表大小
```sql
-- 查看表大小
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'your_database_name' 
AND table_name = 'game_logs';
```

## 故障排除

### 1. 表创建失败
- 检查数据库用户权限
- 确认MySQL版本支持JSON字段（5.7+）
- 检查字符集设置

### 2. 索引创建失败
- 检查是否有重复的索引名
- 确认字段名正确
- 检查索引长度限制

### 3. 权限问题
```sql
-- 授予权限（示例）
GRANT SELECT, INSERT, UPDATE, DELETE ON your_database.game_logs TO 'your_user'@'localhost';
FLUSH PRIVILEGES;
```

## 备份建议

### 1. 定期备份
```bash
# 备份表结构和数据
mysqldump -u username -p database_name game_logs > game_logs_backup.sql
```

### 2. 只备份结构
```bash
# 只备份表结构
mysqldump -u username -p --no-data database_name game_logs > game_logs_structure.sql
```

## 联系支持

如果在安装过程中遇到问题，请检查：
1. MySQL版本是否支持（建议5.7+）
2. 数据库用户权限是否足够
3. 字符集设置是否正确
4. 是否有足够的磁盘空间
